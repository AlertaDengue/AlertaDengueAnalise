#!/usr/bin/env Rscript

Organização dos dados do SINAN para o Alerta dengue
====================================================
A serie temporal 2010-13 ja esta pronta. Esse script agrega com a serie de 2014

```{r, echo=FALSE}
#require(foreign)
```

Dados do SINAN 2014
--------------------

```{r}
novosinan <- paste("../",novosinan,sep="")
```

```{r echo=FALSE}
d <- read.dbf(novosinan)[,c("DT_NOTIFIC","SEM_NOT","NU_ANO","DT_SIN_PRI",
                          "SEM_PRI","NM_BAIRRO")]
head(d)
```


**Criar variavel APS**

```{r echo=FALSE}
baps<-read.csv("../tabelas/bairro2AP.csv")
d2<-merge(d,baps,by.x="NM_BAIRRO",by.y="bairro")
```

Numero de registros sem AP (falha no mapeamento bairro -> APS)
```{r echo=FALSE}
dim(d)[1]-dim(d2)[1]
```


**Serie temporal de casos no municipio todo em 2014**

```{r echo=FALSE}
st14 <- aggregate(d$SEM_PRI,by=list(d$SEM_PRI),FUN=length)
names(st14)<-c("SE","casos")
st14$SE<-as.numeric(as.character(st14$SE))
tail(st14)
```

**Total de casos no ano**

```{r echo=FALSE}
#Cria Serie temporal de casos por APS em 2014
listaAPS<-unique(baps$APS)
sem <- unique(d$SEM_PRI)
st14.ap <- expand.grid(SE=sem,APS=listaAPS)
st14.ap$casos <- NA
for(i in 1:dim(st14.ap)[1]) st14.ap$casos[i]<-length(d2$SEM_PRI[d2$SEM_PRI %in% st14.ap$SE[i] & d2$APS %in% st14.ap$APS[i]])
sum(st14.ap$casos)
st14.ap$SE<-as.numeric(as.character(st14.ap$SE))
```


```{r echo=FALSE}
# Juntando com dados de anos anteriores
load("../dados_brutos/sinan/casos2010-2013.Rdata")
st10.13$SE<-as.numeric(as.character(st10.13$SE))
st10.13.aps$SE<-as.numeric(as.character(st10.13.aps$semana))

st<-rbind(st10.13,st14)
st.ap<-rbind(st10.13.aps[,c(4,3,2)],st14.ap) 

st<-st[order(st$SE),]
st.ap <-st.ap[order(st.ap$SE),]
```


**Serie temporal de casos na cidade**
```{r echo=FALSE}
plot(st$casos,type='l',ylab="casos",xlab="",axes=FALSE)
axis(2)
axis(1,at=seq(1,length(st$SE),by=6*4),label=st$SE[seq(1,length(st$SE),by=6*4)],las=2,cex.axis=0.7)
```


**Serie temporal de casos por APS**
```{r echo=FALSE}
plot(st.ap$casos[st.ap$APS==listaAPS[1]],type="l",ylim=1.5*range(st.ap$casos),xlab="",ylab="casos",axes=FALSE)
for (j in 2:10) lines(st.ap$casos[st.ap$APS==listaAPS[j]],col=j)
axis(2)
sem <- sort(unique(st.ap$SE))
axis(1,at=seq(1,length(sem),by=6*4),label=sem[seq(1,length(sem),by=6*4)],las=2,cex.axis=0.7)
legend(0,1.5*max(st.ap$casos),listaAPS,lty=1,col=1:10,cex=0.6)
```

**Salvando**
```{r echo=FALSE}
#outputfile1 = paste("../dados_limpos/sinanAP_",max(st$SE),".csv",sep="")
write.table(st.ap,file="../dados_limpos/sinansemanaAP_RJ.csv",sep=",",row.names=FALSE)
#outputfile2 = paste("../dados_limpos/sinanRJ_",max(st$SE),".csv",sep="")
write.table(st,file="../dados_limpos/sinansemana_RJ.csv",sep=",",row.names=FALSE)
```

